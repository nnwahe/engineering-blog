<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    
        
    
    <meta property="og:site_name" content="Monsanto Engineering Blog" />
    <meta property="og:title" content="Cloud Foundry Metrics" />
    <meta property="og:description" content="Announcing CF-Metrics, an example of open source monitoring and alerting with Cloud Foundry" />
    <meta property="og:url" content="http://engineering.monsanto.com/2015/08/20/cf-metrics/" />
    <meta property="og:image" content="http://engineering.monsanto.com/img/mon-chesterfield.jpg" />
    <meta name="description" content="Announcing CF-Metrics, an example of open source monitoring and alerting with Cloud Foundry" />
    

    <link rel="shortcut icon" href="/favicon.ico" />

    <title>Cloud Foundry Metrics - Engineering at Monsanto</title>

    <link rel="canonical" href="http://engineering.monsanto.com/2015/08/20/cf-metrics/" />

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.min.css" />
    <link rel="stylesheet" href="/css/scala-colors.min.css" />

    

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css" />

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Engineering at Monsanto</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                <li>
                    <a href="/about/">About</a>
                </li>
                
                <li>
                    <a href="/code/">Code</a>
                </li>
                
                <li>
                    <a href="/contact/">Contact</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/mon-chesterfield.jpg')">
    <div class="heading-underlay">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Cloud Foundry Metrics</h1>
                        
                        <h2 class="subheading">Open Source Monitoring and Alerting for Cloud Foundry</h2>
                        
                        <span class="meta">Posted  by Mark Seidenstricker on August 20, 2015</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-body">

				<p>In the second installation of our open source <a href="http://engineering.monsanto.com/2015/07/22/building-an-open-source-cloud-foundry-toolbox/">Cloud Foundry (CF) toolbox series</a> we would like to introduce <a href="https://github.com/MonsantoCo/cf-metrics">CF-Metrics</a>, a comprehensive solution for Cloud Foundry monitoring and alerting based solely on open source projects.  In a world of unreliable cloud infrastructure and distributed micro service architectures, monitoring and alerting are as critical now as they&#39;ve ever been.  Even when you learn to expect failure (or better yet <a href="https://github.com/strepsirrhini-army/chaos-lemur">embrace it</a>) and build self healing platforms like Cloud Foundry, you still need monitoring and alerting to analyze why there was a failure and how to make it not happen again in the future.</p>

<h2>Lowering the Cost of Entry</h2>

<p>When we first started with Cloud Foundry at Monsanto, monitoring was one of the key areas the team needed to tackle to feel comfortable running the platform. Maybe it&#39;s a placebo effect, but knowing I have the ability to graph any metric at will keeps me from loosing sleep at night.  And although this topic remains highly requested in meetups and mailing lists, publicized documentation and more importantly downloadable working implementations are still relatively sparse.</p>

<p>By releasing CF-Metrics, we hope to provide a solution which will help new community users get off the ground quicker by:</p>

<ul>
<li>Being one of the quickest and most painless ways to get up and running with a functional CF monitoring solution </li>
<li>Re-using existing components to eliminate the need to run custom plugins and/or forked releases</li>
</ul>

<h2>The Setup</h2>

<p>CF-Metrics is a combination of open source tools (Heka, InfluxDB, and Grafana) running as a docker compose application.  Packaging the tools via docker makes it compact and highly portable to a variety of hosting solutions.  We purposefully elected not to package the application as a BOSH release since it&#39;s best practice not to run your monitoring solution on the platform that it is monitoring.
<img src=/img/cf-metrics-arch.png  width=700 height=400/></p>

<h2>Gathering the metrics</h2>

<p>To gather metrics we are utilizing two components that have been a part of BOSH and Cloud Foundry for a long time time: CF collector and BOSH monitor.  CF collector is in charge of grabbing metrics from two built-in endpoints (/varz and /healthz) published by every job in the Cloud Foundry release.  By default it does this every thirty seconds and returns a wealth of statistics about the performance, utilization, and health of each job.  BOSH monitor talks to the BOSH agent installed on every VM in the releases it deploys and gathers OS related metrics such as CPU, swap, and disk utilization.</p>

<p>These components have the capability to forward their consolidated metric streams to a number of 3rd party tools via configuration in their release ymls.  For the purposes of our project, we are choosing to forward BOSH and CF metrics via the common graphite protocol and BOSH events via the new BOSH monitor consul plugin.</p>

<h2>Processing</h2>

<p>To process the metric and event stream, we chose Mozilla&#39;s open source stream processing system <a href="http://hekad.readthedocs.org/en/latest/index.html">Heka</a>.  Heka is lightweight and its lua sandbox functionality gives it the ability to perform a large variety of functions.  Once the metric and event data is sent to Heka, it is decoded from graphite to Heka format and then streamed through a variety of filters to accomplish our specific tasks.  </p>

<h2>Alerting</h2>

<p>Alerting through Heka is done through configuration of sandbox filters.  There are filters which trigger on specific message types flowing through the system and perform logic to determine if an alert is required.  It then uses the built-in alert module to inject an alert message into the Heka stream and set a timer to throttle additional alerts of that type for the specified time.  Alert messages are then picked up by a separate sandbox and sent to a Heka output such as an email address or a slack channel.</p>

<p>We&#39;ve included some alert filters we find useful such as swap utilization and DEA memory ratios, but creating your own is as easy as creating a new Heka filter with your custom logic.  Heka also has built in anomaly detection modules so if you&#39;re adventurous you can go beyond traditional threshold based alerting.</p>

<h2>Storing and Trending</h2>

<p>Once the metric and event data has flowed through the filters a heka encoder and output are used to dump the metrics we want to persist to a InfluxDB database.  This data is then accessible via Grafana to create ad-hoc graphs or custom dashboards like the one below
<img src="/img/cf-metrics-dea.png" alt="DEA Stats "></p>

<h2>Ready, Set, Go!</h2>

<p>For a deeper look at CF-Metrics head over to the <a href="https://github.com/MonsantoCo/cf-metrics">github page</a> to try it out for yourself.  If you make a feature enhancement or useful dashboard we&#39;d love a PR to include it in the project.  Or if you have your own solution for Cloud Foundry monitoring and alerting, hopefully we&#39;ve encouraged you to pay it forward and share it with the community.</p>


                

                        <div class="post-signature multiple">
                            posted on August 20, 2015 by <br>
                        


                            <div class="author">
                                
                                <img src="https://avatars2.githubusercontent.com/u/4573660?v=3&s=40">
                                
                                    <span>
                                        Mark Seidenstricker
                                    </span>

                                
                                
                                <a  href="https://github.com/mjseid">
                                    <i class="fa fa-github fa-1x"></i>
                                </a>
                                
                            </div>
                        
                        </div>
                

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2015/08/11/simple-spray/" data-toggle="tooltip" data-placement="top" title="Building a simple Spray application">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2015/09/21/leaflet-light-cluster/" data-toggle="tooltip" data-placement="top" title="Cluster Lightly">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="https://twitter.com/MonPlatformEng">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.youtube.com/MonsantoCo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-youtube-square fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.facebook.com/MonsantoCo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/MonsantoCo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                </ul>
                <p class="copyright text-muted">Copyright &copy; 2015 Engineering at Monsanto &nbsp;|&nbsp; Built with <a href="http://jekyllrb.com/">Jekyll</a> and hosted on <a href="https://pages.github.com/">GitHub Pages</a><br />
                    <a href="/sitemap.xml">Sitemap</a> &nbsp;|&nbsp;
                    <a href="http://www.monsanto.com/legal-notice/Pages/default.aspx">Legal Notice</a> &nbsp;|&nbsp;
                    <a href="http://www.monsanto.com/privacy-policy/Pages/default.aspx">Privacy Policy</a> &nbsp;|&nbsp;
                    <a href="/contact">Contact Us</a>

                    </p>
                <div align="center"><br /><img src="/img/Monsanto_logo.jpg" width="170" height="54" border="0" /></div>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>

<!-- Google Analytics JavaScript -->

<script>
if (/monsanto\.com/.test(window.location.hostname)) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-43186905-16', 'auto');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');

    var trackOutboundLink = function(url) {
        ga('send', 'event', 'outbound', 'click', url, {'hitCallback':
                function () {
                    document.location = url;
                }
        });
    }
}
</script>
<script src="/js/main.js"></script>


</body>

</html>
