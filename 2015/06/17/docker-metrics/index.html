<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    
        
    
    <meta property="og:site_name" content="Monsanto Engineering Blog" />
    <meta property="og:title" content="Doing Docker Metrics" />
    <meta property="og:description" content="How To Do Production Ready Docker Metrics" />
    <meta property="og:url" content="http://engineering.monsanto.com/2015/06/17/docker-metrics/" />
    <meta property="og:image" content="http://engineering.monsanto.com/img/mon-city_garden.jpg" />
    <meta name="description" content="How To Do Production Ready Docker Metrics" />
    

    <link rel="shortcut icon" href="/favicon.ico" />

    <title>Doing Docker Metrics - Engineering at Monsanto</title>

    <link rel="canonical" href="http://engineering.monsanto.com/2015/06/17/docker-metrics/" />

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.min.css" />
    <link rel="stylesheet" href="/css/scala-colors.min.css" />

    

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css" />

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Engineering at Monsanto</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                <li>
                    <a href="/about/">About</a>
                </li>
                
                <li>
                    <a href="/code/">Code</a>
                </li>
                
                <li>
                    <a href="/contact/">Contact</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/mon-city_garden.jpg')">
    <div class="heading-underlay">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Doing Docker Metrics</h1>
                        
                        <h2 class="subheading">How To Do Production Ready Docker Metrics</h2>
                        
                        <span class="meta">Posted  by Stuart Wong on June 17, 2015</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-body">

				<p>As our usage of <a href="http://www.docker.com">Docker</a> grows and we provision more container hosts, collecting metrics and monitoring containers and hosts has become a necessity. This post will walk you through how to glue together a few components to deploy a monitoring solution for Docker. All components are intentionally plug-and-play, so if things need to be changed any component can be (relatively) easily swapped out for an alternative.</p>

<h2>Some assumptions</h2>

<p>First, we assume that Docker is installed, configured and running on your hosts. We further assume that you can connect to your Docker hosts with a web browser. It&#39;s worth noting some of our other requirements at this point since there may be some questions as to why certain decisions were made.</p>

<ul>
<li>Ease of deployment - We believe in fail fast, and succeed fast. We wanted an immediate solution to get up and running quickly, run some tests and make a quick, but informed decision.</li>
<li>Scalability - Success tends to have its own set of problems, namely scale. The solution needed to scale at all levels, handling both data velocity, volume and query demands.</li>
<li>Availability - This goes without saying since we plan on doing notifications from the system and not just support analysis and planning.</li>
</ul>

<p>With that said, lets get to the good stuff!</p>

<h2>Components for Docker Metrics and Monitoring</h2>

<p>There are three components to our Docker monitoring setup: cAdvisor, InfluxDB, and Grafana.</p>

<p><a href="https://github.com/google/cadvisor">cAdvisor or Container Advisor</a> - A Google developed tool that provides host and container metrics. It&#39;s a host daemon that collects, aggregates, processes and exports information about running containers. We run it within a container on each host with various host volumes exposed which allow it to collect metrics from the Docker containers running on the host. It provides an available dashboard with a default 60 second data aggregation interval. It has a few options for back ends which can be used to store the data for longer term retrieval and analysis.</p>

<p><a href="http://influxdb.com/">InfluxDB</a> - An open source distributed time series database which we use for longer term storage and analysis of the data from cAdvisor. It&#39;s still under development but works fine and does have scale-out capabilities, though for the time being we are using a single container instance until we can upgrade to a stable 0.9.x version.
We would have liked to standardize on the soon to be released 0.9.x version, however, at this time <strong><a href="https://github.com/google/cadvisor/issues/743">cAdvisor</a> does not yet support the InfluxDB 0.9.x API</strong>. Though there are other non-completed features which also affect the UI component, this is the primary reason we will be using the 0.8.x version at this time.</p>

<p><a href="http://grafana.org/">Grafana</a> - A nice open source web based UI which allows us to visualize all the metrics data. We create various dashboards which allow us to run queries against InfluxDB and chart them accordingly in a very nice layout.</p>

<h2>Putting things together</h2>

<p>Now that you have an overview of the different components lets put things together.</p>

<ol>
<li><p>We start first with our <a href="https://registry.hub.docker.com/u/tutum/influxdb/">InfluxDB container</a> using the below fleet/systemd unit:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">[Unit]
Description=InfluxDB Service

Requires=docker.service
After=docker.service

[Service]
Restart=always
RestartSec=5s

ExecStartPre=-/usr/bin/docker rm -f %p
ExecStartPre=/usr/bin/docker pull tutum/influxdb:latest

ExecStart=/usr/bin/docker run --publish=8083:8083 --publish=8086:8086 \
  --name=%p tutum/influxdb:latest

ExecStop=/usr/bin/docker stop %p
ExecStopPost=-/usr/bin/docker rm -f %p

[Install]
WantedBy=multi-user.target

[X-Fleet]
MachineID=[your_machine_ID]
</code></pre></div>
<p>You can just extract and use the above <code>docker run</code> command if you prefer. I provide the above systemd unit for a more complete, &quot;production-ready&quot; example. You will notice the <strong>[X-Fleet]</strong> section is specific to <a href="https://github.com/coreos/fleet"><code>fleet</code></a>, which is our container scheduler on CoreOS hosts (hence the <code>MachineID</code> which comes from <code>cat /etc/machine-id</code>). In a true production environment you would not hardcode the host using <code>MachineID</code> as I&#39;ve done above, but in my test setup I&#39;m not using any service discovery mechanisms. For further production readiness you would use a data volume container or other means of persisting the storage when the container is restarted.</p>

<p>To run the unit and create the required database for cAdvisor:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">fleetctl start influxdb.service
sleep 10
curl -X POST <span class="s1">&#39;http://[influxdb_hostname]:8086/db?u=root&amp;p=root&#39;</span> -d <span class="s1">&#39;{&quot;name&quot;: &quot;cadvisor&quot;}&#39;</span>
</code></pre></div>
<p>The <code>sleep 10</code> is there to allow InfluxDB a few seconds to be ready as Docker will need to <code>pull</code> (download) the image, and the InfluxDB itself time to start. The <code>curl</code> statement creates a database for storing the cAdvisor data, called <strong>&quot;cadvisor&quot;</strong> with a default configuration - the credentials to log into InfluxDB are as shown, i.e. <strong>root/root</strong>.  Be sure to replace <code>[influxdb_hostname]</code> with the actual IP or DNS resolvable hostname of your InfluxDB container host.</p>

<p>Note that the InfluxDB dashboard can be accessed via the exposed <strong>UI port 8083</strong>, i.e., type <code>http://[influxdb_hostname]:8083</code> in your web browser. Port <strong>8086 is for API access</strong>, as used by the <code>curl</code> statement and cAdvisor. If you are doing clustering you will need to also expose the cluster ports, 8090 and 8099.</p></li>
<li><p>We now start the <a href="https://registry.hub.docker.com/u/google/cadvisor/">cAdvisor container</a> across all our hosts, using the this fleet/systemd unit:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">[Unit]
Description=Google Container Advisor (cAdvisor)

Requires=docker.service
After=docker.service

[Service]
Restart=always
RestartSec=5s

ExecStartPre=-/usr/bin/docker rm -f %p
ExecStartPre=/usr/bin/docker pull google/cadvisor:latest

ExecStart=/usr/bin/docker run --volume=/:/rootfs:ro --volume=/var/run:/var/run:rw \
  --volume=/sys:/sys:ro --volume=/var/lib/docker/:/var/lib/docker:ro \
  --publish=8080:8080 --name=%p google/cadvisor:latest --logtostderr \
  -storage_driver=influxdb -storage_driver_host=[influxdb_hostname]:8086 \
  -storage_driver_db=cadvisor -storage_driver_user=root -storage_driver_password=root

ExecStop=/usr/bin/docker stop %p
ExecStopPost=-/usr/bin/docker rm -f %p

[Install]
WantedBy=multi-user.target

[X-Fleet]
Global=true
</code></pre></div>
<p>To run the unit file:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">fleetctl start cadvisor.service
</code></pre></div>
<p>The <code>Global=true</code> in the <code>fleet</code> specific section indicates that this unit will be started across all Docker container hosts. Again, ensure you replace the <code>[influxdb_hostname]</code> in the Docker run statement with the appropriate value for your InfluxDB host.</p>

<p>Here we are exposing required Docker host volumes to the container so it can read the host and container metrics from the Docker host. We are also publishing the <strong>cAdvisor port to enable the built-in dashboard (on port 8080)</strong>. You can refer to the cAdvisor documentation on the specific command line options but here we are just providing the InfluxDB details, i.e., the storage driver type (&#39;influxdb&#39;), host, database name (&#39;cadvisor&#39;), database user (&#39;root&#39;) and database password (&#39;root&#39;).</p>

<p>You can access the cAdvisor dashboard for each host by entering the URL <code>http://[cadvisor_hostname]:8080</code> in your web browser.</p>

<p><img src="/img/cadvisor-01.png" alt="cAdvisor Home Page"></p>

<p><img src="/img/cadvisor-02.png" alt="cAdvisor Metrics 1"></p>

<p><img src="/img/cadvisor-03.png" alt="cAdvisor Metrics 2"></p></li>
<li><p>Install the Grafana dashboard using the fleet/systemd unit:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">[Unit]
Description=Grafana UI Service

Requires=docker.service
Wants=influxdb.service
After=docker.service
After=influxdb.service
BindsTo=influxdb.service

[Service]
Restart=on-failure
RestartSec=5

ExecStartPre=-/usr/bin/docker rm -f %p
ExecStartPre=/usr/bin/docker pull grafana/grafana:latest

ExecStart=/usr/bin/docker run --publish=3000:3000 \
  --env INFLUXDB_HOST=%H --env INFLUXDB_PORT=8086 --env INFLUXDB_NAME=cadvisor \
  --env INFLUXDB_USER=root --env INFLUXDB_PASS=root \
  --name=%p grafana/grafana:latest

ExecStop=/usr/bin/docker stop %p
ExecStopPost=-/usr/bin/docker rm -f %p

[Install]
WantedBy=multi-user.target

[X-Fleet]
MachineOf=influxdb.service
</code></pre></div>
<p>To run the unit file:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">fleetctl start grafana.service
</code></pre></div>
<p>We use the <a href="https://registry.hub.docker.com/u/grafana/grafana/">official Grafana 2.x container image</a>, using environment variables to connect to the <code>cadvisor</code> InfluxDB database. By using the <code>fleet</code> specific <code>MachineOf</code> unit statement we pin the container to the same host as the InfluxDB container. The Grafana dashboard can now be accessed via your web browser at <code>http://[grafana_hostname]:3000</code>.</p></li>
</ol>

<h2>Connecting to Grafana and creating dashboards</h2>

<p>Once your full stack is up, you&#39;ll then need to connect Grafana to your <code>cadvisor</code> database within InfluxDB and create some useful graphs.</p>

<ol>
<li><p>Start by opening a web page to <code>http://[grafana_hostname]:3000</code> and log in using the default Grafana credentials, <strong>admin/admin</strong>. <em>You will need to change this password and enable the appropriate authentication and authorization mechanisms for a production deployment</em>.</p>

<p><img src="/img/grafana-home.jpg" alt="Grafana Home"></p></li>
<li><p>Create a new data source connection to the <code>cadvisor</code> InfluxDB database by first exposing the data source menu by clicking on the Grafana fireball icon in the top left hand corner of the UI, then selecting <em>Data Sources</em> -&gt; <em>Add New</em></p>

<p><img src="/img/grafana-newds.png" alt="Grafana New Data Source"></p>

<p>Enter the appropriate information:</p>

<p><strong>Add data source settings</strong><br>
Name: influxdb<br>
Type: InfluxDB 0.8.x<br>
Default (checked)  </p>

<p><strong>Http settings</strong><br>
Url: http://[influxdb_hostname]:8086<br>
Basic Auth (enabled)<br>
User: root<br>
Password: root  </p>

<p><strong>InfluxDB Details</strong><br>
Database: cadvisor<br>
User: root<br>
Password: root  </p>

<p><img src="/img/grafana-ds.png" alt="Grafana Creating a Data Source"></p></li>
<li><p>Now comes what may be the hardest part: creating useful dashboards. Click on the <em>Home</em> icon (top left corner) and select <em>+New</em> to create a new dashboard.</p>

<p><img src="/img/grafana-dash.jpg" alt="Grafana Dashboard"></p>

<p>Hover over, and select the thin green icon bar (top far left, below fireball) and <em>Add Panel</em> -&gt; <em>Graph</em> from the displayed sub-menus.</p>

<p><img src="/img/grafana-newdash.jpg" alt="Grafana New Dashboard"></p>

<p>Select the <em>no title (click here)</em> and <em>edit</em> from the displayed sub-menu.</p>

<p><img src="/img/grafana-graph.png" alt="Grafana Creating a Graph"></p>

<p>Now we can create a quick first graph. In the <em>series</em> section fill in &#39;stats&#39;, then &#39;Limit&#39; in the <em>alias</em> section. Use &#39;fs_limit&#39; as the value for <em>mean</em> in the <em>select</em> section. Click on <em>+Add query</em> to add an additional query/graph line and enter &#39;Usage&#39; in the <em>alias</em> section and &#39;fs_usage&#39; as the value for <em>mean</em> in the <em>select</em> section here. You will see values being plotted as soon as we enter values, and by now you will realize we are doing a simple <em>file system limit vs usage graph</em>.</p>

<p><img src="/img/grafana-query.png" alt="Grafana Writing a Query"></p>

<p>To complete our graph let&#39;s give it a better name, and more meaningful unit values. Click on <em>General</em> and give your graph a name, for example &#39;File System&#39;. Then click on &#39;Axes &amp; Grid&#39; and use the &#39;byte&#39; unit for the <em>Left Y</em> axis unit.</p>

<p><img src="/img/grafana-name.png" alt="Grafana Naming a Graph"></p>

<p><img src="/img/grafana-axis.png" alt="Grafana Axis Units"></p>

<p>Once complete, ensure you click the <em>Save</em> icon (near top left of screen) to save your dashboard. By default Grafana 2.x saves dashboards to it&#39;s embedded sqlite3 database though they can be exported and imported as well. You can also use other supported storage backends.</p></li>
</ol>

<h2>Conclusion</h2>

<p>You&#39;ve now built a Docker metrics collection system with a single Grafana dashboard for file system statistics. We&#39;ve only just begun so relevant dashboards are still being built, but check out the <a href="http://docs.grafana.org/reference/graph/">Grafana reference docs</a> to get better acquainted with it&#39;s capabilities. You can look out for future posts on more of the components being used in our platform solution such as <a href="https://github.com/GoogleCloudPlatform/heapster">Heapster</a>, which we are looking at for tying together all the cAdvisor agents and provide a cluster-view, and our take on persistent storage in a Docker environment.</p>

<p>I hope this has proven useful to you. Please keep in touch and let us know your thoughts and what you might be working on as well.</p>

<p>Good luck!</p>


                

                        <div class="post-signature multiple">
                            posted on June 17, 2015 by <br>
                        


                            <div class="author">
                                
                                <img src="https://avatars2.githubusercontent.com/u/6033436?v=3&s=40">
                                
                                    <span>
                                        Stuart Wong
                                    </span>

                                
                                <a  href="https://twitter.com/cgswong">
                                    <i class="fa fa-twitter fa-1x "></i>
                                </a>
                                
                                
                                <a  href="https://github.com/cgswong">
                                    <i class="fa fa-github fa-1x"></i>
                                </a>
                                
                            </div>
                        
                        </div>
                

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2015/06/15/implicits-futures/" data-toggle="tooltip" data-placement="top" title="Learn implicits: Scala Futures">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2015/07/08/stax/" data-toggle="tooltip" data-placement="top" title="Stax">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="https://twitter.com/MonPlatformEng">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.youtube.com/MonsantoCo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-youtube-square fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.facebook.com/MonsantoCo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/MonsantoCo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                </ul>
                <p class="copyright text-muted">Copyright &copy; 2015 Engineering at Monsanto &nbsp;|&nbsp; Built with <a href="http://jekyllrb.com/">Jekyll</a> and hosted on <a href="https://pages.github.com/">GitHub Pages</a><br />
                    <a href="/sitemap.xml">Sitemap</a> &nbsp;|&nbsp;
                    <a href="http://www.monsanto.com/legal-notice/Pages/default.aspx">Legal Notice</a> &nbsp;|&nbsp;
                    <a href="http://www.monsanto.com/privacy-policy/Pages/default.aspx">Privacy Policy</a> &nbsp;|&nbsp;
                    <a href="/contact">Contact Us</a>

                    </p>
                <div align="center"><br /><img src="/img/Monsanto_logo.jpg" width="170" height="54" border="0" /></div>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>

<!-- Google Analytics JavaScript -->

<script>
if (/monsanto\.com/.test(window.location.hostname)) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-43186905-16', 'auto');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');

    var trackOutboundLink = function(url) {
        ga('send', 'event', 'outbound', 'click', url, {'hitCallback':
                function () {
                    document.location = url;
                }
        });
    }
}
</script>
<script src="/js/main.js"></script>


</body>

</html>
